<?xml version="1.0" encoding="UTF-8"?>

<!-- mapper 태그를 사용하기 위한 코드 -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="common.mapper">
	<!-- 댓글 삭제 -->
	<update id="comment_delete">
		delete from board_comment where comment_no = #{comment_no}
	</update>

	<!-- 대댓글 DB 저장 -->
	<insert id="reply_regist">
		insert into board_comment(comment_bno, comment_writer, comment_content, comment_category, 
								  comment_nickname, comment_root, comment_step, comment_reply)
		values (#{comment_bno}, #{comment_writer}, #{comment_content}, 
				#{comment_category}, #{comment_nickname}, #{comment_root}, 
				 (select nvl(max(comment_step),0) from board_comment 
				 	where comment_root = #{comment_root}) + 1, 
				 #{comment_reply})		
	</insert>
	
	<!-- 댓글 수정 -->
	<update id="comment_update">
		update board_comment set comment_content = #{comment_content}
		where comment_no = #{comment_no}
	</update>

	<!-- 닉네임 설정 -->
	<select id="countWriter" resultType="Integer">
		select count(*) from 
			(select * from board_comment 
			where comment_bno = #{comment_bno}
			and comment_category = #{comment_category}) 
		where comment_writer = #{comment_writer}
	</select>
	<select id="selectMaxNickname" resultType="Integer">
		select nvl(max(comment_nickName), 0) from board_comment 
		where comment_bno = #{comment_bno} 
		and comment_category = #{comment_category}
	</select>
	<select id="selectNickname" resultType="Integer">
		select comment_nickName from board_comment 
		where comment_writer = #{comment_writer} and comment_bno = #{comment_bno}
		group by comment_nickname
	</select>
	
	<!-- comment_root 컬럼 DB 업데이트 -->
	<update id="comment_rootUpdate">
		update (select * from board_comment 
				where comment_bno = #{comment_bno} and comment_reply = 'N') 
		set comment_root = comment_no 
		where comment_root = 0
	</update>
	
	<!-- 댓글 목록 조회 -->
	<select id="comment_list" resultType="common.BoardCommentVO">
		select c.*,
			to_char(comment_writedate, 'yyyy-mm-dd hh24:mi:ss') comment_writedate
		from board_comment c 
		where comment_bno = #{comment_bno} and comment_category = #{comment_category}
		order by comment_root asc, comment_step asc
	</select>
	
	<!-- 댓글 DB 저장 -->
	<insert id="comment_regist">
		insert into board_comment(comment_bno, comment_writer, comment_content, 
								  comment_category, comment_nickname)
		values (#{comment_bno}, #{comment_writer}, #{comment_content}, 
				#{comment_category}, #{comment_nickname})
	</insert>
</mapper>